import { print } from 'graphql';
import { Injectable } from '@angular/core';
import { ApolloLink, Observable as LinkObservable, } from '@apollo/client/core';
import { BatchLink } from '@apollo/client/link/batch';
import { createHeadersWithClientAwareness, fetch, mergeHeaders, prioritize } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const defaults = {
    batchInterval: 10,
    batchMax: 10,
    uri: 'graphql',
    method: 'POST',
    withCredentials: false,
    includeQuery: true,
    includeExtensions: false,
    useMultipart: false,
};
/**
 * Decides which value to pick from Context, Options or defaults
 */
export function pick(context, options, key) {
    return prioritize(context[key], options[key], defaults[key]);
}
export class HttpBatchLinkHandler extends ApolloLink {
    httpClient;
    options;
    batcher;
    batchInterval;
    batchMax;
    print = print;
    constructor(httpClient, options) {
        super();
        this.httpClient = httpClient;
        this.options = options;
        this.batchInterval = options.batchInterval || defaults.batchInterval;
        this.batchMax = options.batchMax || defaults.batchMax;
        if (this.options.operationPrinter) {
            this.print = this.options.operationPrinter;
        }
        const batchHandler = (operations) => {
            return new LinkObservable((observer) => {
                const body = this.createBody(operations);
                const headers = this.createHeaders(operations);
                const { method, uri, withCredentials } = this.createOptions(operations);
                if (typeof uri === 'function') {
                    throw new Error(`Option 'uri' is a function, should be a string`);
                }
                const req = {
                    method,
                    url: uri,
                    body: body,
                    options: {
                        withCredentials,
                        headers,
                    },
                };
                const sub = fetch(req, this.httpClient, () => {
                    throw new Error('File upload is not available when combined with Batching');
                }).subscribe({
                    next: result => observer.next(result.body),
                    error: err => observer.error(err),
                    complete: () => observer.complete(),
                });
                return () => {
                    if (!sub.closed) {
                        sub.unsubscribe();
                    }
                };
            });
        };
        const batchKey = options.batchKey ||
            ((operation) => {
                return this.createBatchKey(operation);
            });
        this.batcher = new BatchLink({
            batchInterval: this.batchInterval,
            batchMax: this.batchMax,
            batchKey,
            batchHandler,
        });
    }
    createOptions(operations) {
        const context = operations[0].getContext();
        return {
            method: pick(context, this.options, 'method'),
            uri: pick(context, this.options, 'uri'),
            withCredentials: pick(context, this.options, 'withCredentials'),
        };
    }
    createBody(operations) {
        return operations.map(operation => {
            const includeExtensions = prioritize(operation.getContext().includeExtensions, this.options.includeExtensions, false);
            const includeQuery = prioritize(operation.getContext().includeQuery, this.options.includeQuery, true);
            const body = {
                operationName: operation.operationName,
                variables: operation.variables,
            };
            if (includeExtensions) {
                body.extensions = operation.extensions;
            }
            if (includeQuery) {
                body.query = this.print(operation.query);
            }
            return body;
        });
    }
    createHeaders(operations) {
        return operations.reduce((headers, operation) => {
            return mergeHeaders(headers, operation.getContext().headers);
        }, createHeadersWithClientAwareness({
            headers: this.options.headers,
            clientAwareness: operations[0]?.getContext()?.clientAwareness,
        }));
    }
    createBatchKey(operation) {
        const context = operation.getContext();
        if (context.skipBatching) {
            return Math.random().toString(36).substr(2, 9);
        }
        const headers = context.headers && context.headers.keys().map((k) => context.headers.get(k));
        const opts = JSON.stringify({
            includeQuery: context.includeQuery,
            includeExtensions: context.includeExtensions,
            headers,
        });
        return prioritize(context.uri, this.options.uri, '') + opts;
    }
    request(op) {
        return this.batcher.request(op);
    }
}
export class HttpBatchLink {
    httpClient;
    constructor(httpClient) {
        this.httpClient = httpClient;
    }
    create(options) {
        return new HttpBatchLinkHandler(this.httpClient, options);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: HttpBatchLink, deps: [{ token: i1.HttpClient }], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: HttpBatchLink, providedIn: 'root' });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: HttpBatchLink, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1iYXRjaC1saW5rLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vaHR0cC9zcmMvaHR0cC1iYXRjaC1saW5rLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFaEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsVUFBVSxFQUVWLFVBQVUsSUFBSSxjQUFjLEdBRTdCLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFnQixTQUFTLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7OztBQUU1RixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUc7SUFDdEIsYUFBYSxFQUFFLEVBQUU7SUFDakIsUUFBUSxFQUFFLEVBQUU7SUFDWixHQUFHLEVBQUUsU0FBUztJQUNkLE1BQU0sRUFBRSxNQUFNO0lBQ2QsZUFBZSxFQUFFLEtBQUs7SUFDdEIsWUFBWSxFQUFFLElBQUk7SUFDbEIsaUJBQWlCLEVBQUUsS0FBSztJQUN4QixZQUFZLEVBQUUsS0FBSztDQUNYLENBQUM7QUFFWDs7R0FFRztBQUNILE1BQU0sVUFBVSxJQUFJLENBQ2xCLE9BQWdCLEVBQ2hCLE9BQWdCLEVBQ2hCLEdBQU07SUFFTixPQUFPLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQy9ELENBQUM7QUFFRCxNQUFNLE9BQU8sb0JBQXFCLFNBQVEsVUFBVTtJQU8vQjtJQUNBO0lBUFosT0FBTyxDQUFhO0lBQ25CLGFBQWEsQ0FBUztJQUN0QixRQUFRLENBQVM7SUFDakIsS0FBSyxHQUFxQixLQUFLLENBQUM7SUFFeEMsWUFDbUIsVUFBc0IsRUFDdEIsT0FBcUI7UUFFdEMsS0FBSyxFQUFFLENBQUM7UUFIUyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLFlBQU8sR0FBUCxPQUFPLENBQWM7UUFJdEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsYUFBYSxJQUFJLFFBQVEsQ0FBQyxhQUFhLENBQUM7UUFDckUsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFFdEQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFO1lBQ2pDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztTQUM1QztRQUVELE1BQU0sWUFBWSxHQUFpQixDQUFDLFVBQXVCLEVBQUUsRUFBRTtZQUM3RCxPQUFPLElBQUksY0FBYyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7Z0JBQzFDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ3pDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQy9DLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBRXhFLElBQUksT0FBTyxHQUFHLEtBQUssVUFBVSxFQUFFO29CQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7aUJBQ25FO2dCQUVELE1BQU0sR0FBRyxHQUFZO29CQUNuQixNQUFNO29CQUNOLEdBQUcsRUFBRSxHQUFHO29CQUNSLElBQUksRUFBRSxJQUFJO29CQUNWLE9BQU8sRUFBRTt3QkFDUCxlQUFlO3dCQUNmLE9BQU87cUJBQ1I7aUJBQ0YsQ0FBQztnQkFFRixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO29CQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7Z0JBQzlFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztvQkFDWCxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7b0JBQzFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO29CQUNqQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRTtpQkFDcEMsQ0FBQyxDQUFDO2dCQUVILE9BQU8sR0FBRyxFQUFFO29CQUNWLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO3dCQUNmLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztxQkFDbkI7Z0JBQ0gsQ0FBQyxDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFFRixNQUFNLFFBQVEsR0FDWixPQUFPLENBQUMsUUFBUTtZQUNoQixDQUFDLENBQUMsU0FBb0IsRUFBRSxFQUFFO2dCQUN4QixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFTCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksU0FBUyxDQUFDO1lBQzNCLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYTtZQUNqQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsUUFBUTtZQUNSLFlBQVk7U0FDYixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sYUFBYSxDQUNuQixVQUF1QjtRQUV2QixNQUFNLE9BQU8sR0FBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFcEQsT0FBTztZQUNMLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDO1lBQzdDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDO1lBQ3ZDLGVBQWUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsaUJBQWlCLENBQUM7U0FDaEUsQ0FBQztJQUNKLENBQUM7SUFFTyxVQUFVLENBQUMsVUFBdUI7UUFDeEMsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ2hDLE1BQU0saUJBQWlCLEdBQUcsVUFBVSxDQUNsQyxTQUFTLENBQUMsVUFBVSxFQUFFLENBQUMsaUJBQWlCLEVBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQzlCLEtBQUssQ0FDTixDQUFDO1lBQ0YsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUM3QixTQUFTLENBQUMsVUFBVSxFQUFFLENBQUMsWUFBWSxFQUNuQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFDekIsSUFBSSxDQUNMLENBQUM7WUFFRixNQUFNLElBQUksR0FBUztnQkFDakIsYUFBYSxFQUFFLFNBQVMsQ0FBQyxhQUFhO2dCQUN0QyxTQUFTLEVBQUUsU0FBUyxDQUFDLFNBQVM7YUFDL0IsQ0FBQztZQUVGLElBQUksaUJBQWlCLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQzthQUN4QztZQUVELElBQUksWUFBWSxFQUFFO2dCQUNoQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzFDO1lBRUQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxhQUFhLENBQUMsVUFBdUI7UUFDM0MsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUN0QixDQUFDLE9BQW9CLEVBQUUsU0FBb0IsRUFBRSxFQUFFO1lBQzdDLE9BQU8sWUFBWSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsVUFBVSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxFQUNELGdDQUFnQyxDQUFDO1lBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU87WUFDN0IsZUFBZSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxlQUFlO1NBQzlELENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVPLGNBQWMsQ0FBQyxTQUFvQjtRQUN6QyxNQUFNLE9BQU8sR0FBeUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRTdFLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNoRDtRQUVELE1BQU0sT0FBTyxHQUNYLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFeEYsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUMxQixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLGlCQUFpQjtZQUM1QyxPQUFPO1NBQ1IsQ0FBQyxDQUFDO1FBRUgsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDOUQsQ0FBQztJQUVNLE9BQU8sQ0FBQyxFQUFhO1FBQzFCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztDQUNGO0FBS0QsTUFBTSxPQUFPLGFBQWE7SUFDSztJQUE3QixZQUE2QixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBQUcsQ0FBQztJQUVoRCxNQUFNLENBQUMsT0FBcUI7UUFDakMsT0FBTyxJQUFJLG9CQUFvQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUQsQ0FBQzt1R0FMVSxhQUFhOzJHQUFiLGFBQWEsY0FGWixNQUFNOzsyRkFFUCxhQUFhO2tCQUh6QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHByaW50IH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEFwb2xsb0xpbmssXG4gIEZldGNoUmVzdWx0LFxuICBPYnNlcnZhYmxlIGFzIExpbmtPYnNlcnZhYmxlLFxuICBPcGVyYXRpb24sXG59IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUnO1xuaW1wb3J0IHsgQmF0Y2hIYW5kbGVyLCBCYXRjaExpbmsgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9saW5rL2JhdGNoJztcbmltcG9ydCB7IEJhdGNoT3B0aW9ucywgQm9keSwgQ29udGV4dCwgT3BlcmF0aW9uUHJpbnRlciwgT3B0aW9ucywgUmVxdWVzdCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgY3JlYXRlSGVhZGVyc1dpdGhDbGllbnRBd2FyZW5lc3MsIGZldGNoLCBtZXJnZUhlYWRlcnMsIHByaW9yaXRpemUgfSBmcm9tICcuL3V0aWxzJztcblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRzID0ge1xuICBiYXRjaEludGVydmFsOiAxMCxcbiAgYmF0Y2hNYXg6IDEwLFxuICB1cmk6ICdncmFwaHFsJyxcbiAgbWV0aG9kOiAnUE9TVCcsXG4gIHdpdGhDcmVkZW50aWFsczogZmFsc2UsXG4gIGluY2x1ZGVRdWVyeTogdHJ1ZSxcbiAgaW5jbHVkZUV4dGVuc2lvbnM6IGZhbHNlLFxuICB1c2VNdWx0aXBhcnQ6IGZhbHNlLFxufSBhcyBjb25zdDtcblxuLyoqXG4gKiBEZWNpZGVzIHdoaWNoIHZhbHVlIHRvIHBpY2sgZnJvbSBDb250ZXh0LCBPcHRpb25zIG9yIGRlZmF1bHRzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwaWNrPEsgZXh0ZW5kcyBrZXlvZiBPbWl0PHR5cGVvZiBkZWZhdWx0cywgJ2JhdGNoSW50ZXJ2YWwnIHwgJ2JhdGNoTWF4Jz4+KFxuICBjb250ZXh0OiBDb250ZXh0LFxuICBvcHRpb25zOiBPcHRpb25zLFxuICBrZXk6IEssXG4pOiBSZXR1cm5UeXBlPHR5cGVvZiBwcmlvcml0aXplPENvbnRleHRbS10gfCBPcHRpb25zW0tdIHwgKHR5cGVvZiBkZWZhdWx0cylbS10+PiB7XG4gIHJldHVybiBwcmlvcml0aXplKGNvbnRleHRba2V5XSwgb3B0aW9uc1trZXldLCBkZWZhdWx0c1trZXldKTtcbn1cblxuZXhwb3J0IGNsYXNzIEh0dHBCYXRjaExpbmtIYW5kbGVyIGV4dGVuZHMgQXBvbGxvTGluayB7XG4gIHB1YmxpYyBiYXRjaGVyOiBBcG9sbG9MaW5rO1xuICBwcml2YXRlIGJhdGNoSW50ZXJ2YWw6IG51bWJlcjtcbiAgcHJpdmF0ZSBiYXRjaE1heDogbnVtYmVyO1xuICBwcml2YXRlIHByaW50OiBPcGVyYXRpb25QcmludGVyID0gcHJpbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogQmF0Y2hPcHRpb25zLFxuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5iYXRjaEludGVydmFsID0gb3B0aW9ucy5iYXRjaEludGVydmFsIHx8IGRlZmF1bHRzLmJhdGNoSW50ZXJ2YWw7XG4gICAgdGhpcy5iYXRjaE1heCA9IG9wdGlvbnMuYmF0Y2hNYXggfHwgZGVmYXVsdHMuYmF0Y2hNYXg7XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLm9wZXJhdGlvblByaW50ZXIpIHtcbiAgICAgIHRoaXMucHJpbnQgPSB0aGlzLm9wdGlvbnMub3BlcmF0aW9uUHJpbnRlcjtcbiAgICB9XG5cbiAgICBjb25zdCBiYXRjaEhhbmRsZXI6IEJhdGNoSGFuZGxlciA9IChvcGVyYXRpb25zOiBPcGVyYXRpb25bXSkgPT4ge1xuICAgICAgcmV0dXJuIG5ldyBMaW5rT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBib2R5ID0gdGhpcy5jcmVhdGVCb2R5KG9wZXJhdGlvbnMpO1xuICAgICAgICBjb25zdCBoZWFkZXJzID0gdGhpcy5jcmVhdGVIZWFkZXJzKG9wZXJhdGlvbnMpO1xuICAgICAgICBjb25zdCB7IG1ldGhvZCwgdXJpLCB3aXRoQ3JlZGVudGlhbHMgfSA9IHRoaXMuY3JlYXRlT3B0aW9ucyhvcGVyYXRpb25zKTtcblxuICAgICAgICBpZiAodHlwZW9mIHVyaSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICd1cmknIGlzIGEgZnVuY3Rpb24sIHNob3VsZCBiZSBhIHN0cmluZ2ApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVxOiBSZXF1ZXN0ID0ge1xuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICB1cmw6IHVyaSxcbiAgICAgICAgICBib2R5OiBib2R5LFxuICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFscyxcbiAgICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzdWIgPSBmZXRjaChyZXEsIHRoaXMuaHR0cENsaWVudCwgKCkgPT4ge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmlsZSB1cGxvYWQgaXMgbm90IGF2YWlsYWJsZSB3aGVuIGNvbWJpbmVkIHdpdGggQmF0Y2hpbmcnKTtcbiAgICAgICAgfSkuc3Vic2NyaWJlKHtcbiAgICAgICAgICBuZXh0OiByZXN1bHQgPT4gb2JzZXJ2ZXIubmV4dChyZXN1bHQuYm9keSksXG4gICAgICAgICAgZXJyb3I6IGVyciA9PiBvYnNlcnZlci5lcnJvcihlcnIpLFxuICAgICAgICAgIGNvbXBsZXRlOiAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgIGlmICghc3ViLmNsb3NlZCkge1xuICAgICAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGJhdGNoS2V5ID1cbiAgICAgIG9wdGlvbnMuYmF0Y2hLZXkgfHxcbiAgICAgICgob3BlcmF0aW9uOiBPcGVyYXRpb24pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlQmF0Y2hLZXkob3BlcmF0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5iYXRjaGVyID0gbmV3IEJhdGNoTGluayh7XG4gICAgICBiYXRjaEludGVydmFsOiB0aGlzLmJhdGNoSW50ZXJ2YWwsXG4gICAgICBiYXRjaE1heDogdGhpcy5iYXRjaE1heCxcbiAgICAgIGJhdGNoS2V5LFxuICAgICAgYmF0Y2hIYW5kbGVyLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVPcHRpb25zKFxuICAgIG9wZXJhdGlvbnM6IE9wZXJhdGlvbltdLFxuICApOiBSZXF1aXJlZDxQaWNrPE9wdGlvbnMsICdtZXRob2QnIHwgJ3VyaScgfCAnd2l0aENyZWRlbnRpYWxzJz4+IHtcbiAgICBjb25zdCBjb250ZXh0OiBDb250ZXh0ID0gb3BlcmF0aW9uc1swXS5nZXRDb250ZXh0KCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbWV0aG9kOiBwaWNrKGNvbnRleHQsIHRoaXMub3B0aW9ucywgJ21ldGhvZCcpLFxuICAgICAgdXJpOiBwaWNrKGNvbnRleHQsIHRoaXMub3B0aW9ucywgJ3VyaScpLFxuICAgICAgd2l0aENyZWRlbnRpYWxzOiBwaWNrKGNvbnRleHQsIHRoaXMub3B0aW9ucywgJ3dpdGhDcmVkZW50aWFscycpLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUJvZHkob3BlcmF0aW9uczogT3BlcmF0aW9uW10pOiBCb2R5W10ge1xuICAgIHJldHVybiBvcGVyYXRpb25zLm1hcChvcGVyYXRpb24gPT4ge1xuICAgICAgY29uc3QgaW5jbHVkZUV4dGVuc2lvbnMgPSBwcmlvcml0aXplKFxuICAgICAgICBvcGVyYXRpb24uZ2V0Q29udGV4dCgpLmluY2x1ZGVFeHRlbnNpb25zLFxuICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZUV4dGVuc2lvbnMsXG4gICAgICAgIGZhbHNlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGluY2x1ZGVRdWVyeSA9IHByaW9yaXRpemUoXG4gICAgICAgIG9wZXJhdGlvbi5nZXRDb250ZXh0KCkuaW5jbHVkZVF1ZXJ5LFxuICAgICAgICB0aGlzLm9wdGlvbnMuaW5jbHVkZVF1ZXJ5LFxuICAgICAgICB0cnVlLFxuICAgICAgKTtcblxuICAgICAgY29uc3QgYm9keTogQm9keSA9IHtcbiAgICAgICAgb3BlcmF0aW9uTmFtZTogb3BlcmF0aW9uLm9wZXJhdGlvbk5hbWUsXG4gICAgICAgIHZhcmlhYmxlczogb3BlcmF0aW9uLnZhcmlhYmxlcyxcbiAgICAgIH07XG5cbiAgICAgIGlmIChpbmNsdWRlRXh0ZW5zaW9ucykge1xuICAgICAgICBib2R5LmV4dGVuc2lvbnMgPSBvcGVyYXRpb24uZXh0ZW5zaW9ucztcbiAgICAgIH1cblxuICAgICAgaWYgKGluY2x1ZGVRdWVyeSkge1xuICAgICAgICBib2R5LnF1ZXJ5ID0gdGhpcy5wcmludChvcGVyYXRpb24ucXVlcnkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYm9keTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlSGVhZGVycyhvcGVyYXRpb25zOiBPcGVyYXRpb25bXSk6IEh0dHBIZWFkZXJzIHtcbiAgICByZXR1cm4gb3BlcmF0aW9ucy5yZWR1Y2UoXG4gICAgICAoaGVhZGVyczogSHR0cEhlYWRlcnMsIG9wZXJhdGlvbjogT3BlcmF0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiBtZXJnZUhlYWRlcnMoaGVhZGVycywgb3BlcmF0aW9uLmdldENvbnRleHQoKS5oZWFkZXJzKTtcbiAgICAgIH0sXG4gICAgICBjcmVhdGVIZWFkZXJzV2l0aENsaWVudEF3YXJlbmVzcyh7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMub3B0aW9ucy5oZWFkZXJzLFxuICAgICAgICBjbGllbnRBd2FyZW5lc3M6IG9wZXJhdGlvbnNbMF0/LmdldENvbnRleHQoKT8uY2xpZW50QXdhcmVuZXNzLFxuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQmF0Y2hLZXkob3BlcmF0aW9uOiBPcGVyYXRpb24pOiBzdHJpbmcge1xuICAgIGNvbnN0IGNvbnRleHQ6IENvbnRleHQgJiB7IHNraXBCYXRjaGluZz86IGJvb2xlYW4gfSA9IG9wZXJhdGlvbi5nZXRDb250ZXh0KCk7XG5cbiAgICBpZiAoY29udGV4dC5za2lwQmF0Y2hpbmcpIHtcbiAgICAgIHJldHVybiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSk7XG4gICAgfVxuXG4gICAgY29uc3QgaGVhZGVycyA9XG4gICAgICBjb250ZXh0LmhlYWRlcnMgJiYgY29udGV4dC5oZWFkZXJzLmtleXMoKS5tYXAoKGs6IHN0cmluZykgPT4gY29udGV4dC5oZWFkZXJzIS5nZXQoaykpO1xuXG4gICAgY29uc3Qgb3B0cyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGluY2x1ZGVRdWVyeTogY29udGV4dC5pbmNsdWRlUXVlcnksXG4gICAgICBpbmNsdWRlRXh0ZW5zaW9uczogY29udGV4dC5pbmNsdWRlRXh0ZW5zaW9ucyxcbiAgICAgIGhlYWRlcnMsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJpb3JpdGl6ZShjb250ZXh0LnVyaSwgdGhpcy5vcHRpb25zLnVyaSwgJycpICsgb3B0cztcbiAgfVxuXG4gIHB1YmxpYyByZXF1ZXN0KG9wOiBPcGVyYXRpb24pOiBMaW5rT2JzZXJ2YWJsZTxGZXRjaFJlc3VsdD4gfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5iYXRjaGVyLnJlcXVlc3Qob3ApO1xuICB9XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBIdHRwQmF0Y2hMaW5rIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7fVxuXG4gIHB1YmxpYyBjcmVhdGUob3B0aW9uczogQmF0Y2hPcHRpb25zKTogSHR0cEJhdGNoTGlua0hhbmRsZXIge1xuICAgIHJldHVybiBuZXcgSHR0cEJhdGNoTGlua0hhbmRsZXIodGhpcy5odHRwQ2xpZW50LCBvcHRpb25zKTtcbiAgfVxufVxuIl19